<!DOCTYPE html>
<html class="dark-theme">
<head>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Stack+Sans+Text:wght@200..700&display=swap"
    rel="stylesheet"
  />

  <link rel="stylesheet" href="style.css" />
  <title>FAKEnetflix</title>
</head>
<body>

<div class="header-logIn">
    <img
      src="iamge/Logo/201563513-c2c7a03a-7ee0-4fea-869c-76f83f2557ac.png"
      width="200"
      alt="FAKEnetflix Logo"
      
    />

    <div class="header-Links" >
      <a href="index.html">Home</a>
      <!-- From Uiverse.io by alexruix -->
      <label class="switch">
        <input type="checkbox" />
        <span class="slider"></span>
      </label>
    </div>
  </div>
  <div class="login-wrapper" style="padding-top: 150px;">
    <form class="login-card" action="#" method="get">
      <h1>Book Your Tickets</h1>
      
      <!-- Cinema Location Selection -->
      <label for="cinemaLocation">Select Cinema Location</label>
      <div class="radio-group">
        <label class="radio-option">
          <input type="radio" name="cinemaLocation" id="cinemaLocation" value="jeddah" required>
          <span class="radio-label">Jeddah – Town Square Jeddah</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="cinemaLocation" value="riyadh">
          <span class="radio-label">Riyadh – Al Yasmin district</span>
        </label>
      </div>

      <!-- Show Time -->
      <label for="showTime">Select Show Time</label>
      <div class="radio-group">
        <label class="radio-option">
          <input type="radio" name="showTime" id="showTime" value="7:00 PM" required>
          <span class="radio-label">7:00 PM</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="showTime" value="10:30 PM">
          <span class="radio-label">10:30 PM</span>
        </label>
      </div>

      <!-- Seat Availability Section -->
      <div id="seatAvailabilitySection" class="seat-availability" style="display: none;">
        <h3>Seat Availability</h3>
        <div class="seat-item">
          <span>عدد الكراسي العادية المتاحة:</span>
          <span id="regularSeatsCount">60</span>
        </div>
        <div class="seat-item">
          <span>عدد الكراسي البرو المتاحة:</span>
          <span id="proSeatsCount">40</span>
        </div>
      </div>

      <!-- Ticket Type -->
      <label for="ticketType">Select Ticket Type</label>
      <div class="radio-group">
        <label class="radio-option">
          <input type="radio" name="ticketType" id="ticketType" value="regular" required>
          <span class="radio-label">Regular Ticket (30 SAR)</span>
        </label>
        <label class="radio-option">
          <input type="radio" name="ticketType" value="pro">
          <span class="radio-label">PRO Ticket (40 SAR)</span>
        </label>
      </div>

      <!-- Number of Tickets -->
      <label for="ticketQuantity">Number of Tickets</label>
      <input 
        type="number" 
        id="ticketQuantity"
        name="ticketQuantity" 
        min="1" 
        value="1"
        required
      >

      <!-- Popcorn Checkbox -->
      <div class="login-row" style="justify-content: flex-start;">
        <label class="remember">
          <input type="checkbox" name="wantPopcorn">
          <span>Add Popcorn (15 SAR per portion)</span>
        </label>
      </div>

      <!-- Number of Popcorn Portions -->
      <label for="popcornQuantity">Number of Popcorn Portions</label>
      <input 
        type="number" 
        id="popcornQuantity"
        name="popcornQuantity"
        min="0" 
        value="0"
      >

      <!-- Price Summary - Calculated by Java Backend -->
      <div class="price-breakdown" id="priceSummary">
        <h3 style="margin: 20px 0 10px 0; font-size: 16px; color: #bbb;">Price Summary</h3>
        <div class="price-item" style="display: flex; justify-content: space-between; margin: 8px 0; color: #bbb; font-size: 14px;">
          <span>Tickets:</span>
          <span id="ticketPriceDisplay">Select ticket type</span>
        </div>
        <div class="price-item" style="display: flex; justify-content: space-between; margin: 8px 0; color: #bbb; font-size: 14px;">
          <span>Popcorn:</span>
          <span id="popcornPriceDisplay">0 SAR</span>
        </div>
        <div class="price-item discount" id="discountRow" style="display: none; justify-content: space-between; margin: 8px 0; color: #4CAF50; font-size: 14px;">
          <span>Bulk Discount (10%):</span>
          <span id="discountDisplay">-0 SAR</span>
        </div>
        <div class="price-item total" style="display: flex; justify-content: space-between; margin: 8px 0; color: #fff; font-size: 16px; font-weight: 600; padding-top: 10px; border-top: 1px solid #2a2a2a;">
          <span>Total:</span>
          <span id="totalPriceDisplay">0 SAR</span>
        </div>
        <div id="priceLoading" style="display: none; color: #888; font-size: 12px; margin-top: 5px;">
          Calculating price...
        </div>
      </div>

      <!-- Submit Button -->
      <button type="submit" class="login-btn">
        Complete Booking
      </button>
    </form>
  </div>
  <script src="theme-switcher.js"></script>
  <script>
    // API Base URL - Use localhost for local development
    const API_BASE_URL = 'http://localhost:8080';
    
    // Seat availability and price calculation handler
    document.addEventListener('DOMContentLoaded', function() {
      const locationInputs = document.querySelectorAll('input[name="cinemaLocation"]');
      const timeInputs = document.querySelectorAll('input[name="showTime"]');
      const ticketTypeInputs = document.querySelectorAll('input[name="ticketType"]');
      const ticketQuantityInput = document.getElementById('ticketQuantity');
      const popcornQuantityInput = document.getElementById('popcornQuantity');
      const seatAvailabilitySection = document.getElementById('seatAvailabilitySection');
      
      // Price display elements
      const ticketPriceDisplay = document.getElementById('ticketPriceDisplay');
      const popcornPriceDisplay = document.getElementById('popcornPriceDisplay');
      const discountRow = document.getElementById('discountRow');
      const discountDisplay = document.getElementById('discountDisplay');
      const totalPriceDisplay = document.getElementById('totalPriceDisplay');
      const priceLoading = document.getElementById('priceLoading');
      
      // Debounce timer for API calls
      let priceCalculationTimer;
      
      function checkAndShowSeatAvailability() {
        const locationSelected = Array.from(locationInputs).some(input => input.checked);
        const timeSelected = Array.from(timeInputs).some(input => input.checked);
        
        if (locationSelected && timeSelected) {
          seatAvailabilitySection.style.display = 'block';
        } else {
          seatAvailabilitySection.style.display = 'none';
        }
      }
      
      // Function to calculate price using Java backend API
      async function calculatePrice() {
        const selectedTicketType = document.querySelector('input[name="ticketType"]:checked');
        const ticketQuantity = parseInt(ticketQuantityInput.value) || 0;
        const popcornQuantity = parseInt(popcornQuantityInput.value) || 0;
        
        if (!selectedTicketType || ticketQuantity <= 0) {
          ticketPriceDisplay.textContent = 'Select ticket type';
          totalPriceDisplay.textContent = '0 SAR';
          return;
        }
        
        const ticketType = selectedTicketType.value;
        
        // Show loading indicator
        priceLoading.style.display = 'block';
        
        try {
          // Call Java backend API for price calculation
          const response = await fetch(
            `${API_BASE_URL}/calculateprice?ticketType=${ticketType}&ticketQuantity=${ticketQuantity}&popcornQuantity=${popcornQuantity}`
          );
          
          const data = await response.json();
          
          if (data.success) {
            // Update ticket price display
            ticketPriceDisplay.textContent = `${data.ticketUnitPrice} SAR × ${data.ticketQuantity} = ${data.ticketSubtotal} SAR`;
            
            // Update popcorn price display
            if (popcornQuantity > 0) {
              popcornPriceDisplay.textContent = `${data.popcornUnitPrice} SAR × ${data.popcornQuantity} = ${data.popcornSubtotal} SAR`;
            } else {
              popcornPriceDisplay.textContent = '0 SAR';
            }
            
            // Show/hide discount row
            if (data.discountApplied) {
              discountRow.style.display = 'flex';
              discountDisplay.textContent = `-${data.discount} SAR`;
            } else {
              discountRow.style.display = 'none';
            }
            
            // Update total
            totalPriceDisplay.textContent = `${data.total} ${data.currency}`;
            
            // Store total for form submission
            document.getElementById('calculatedTotal').value = data.total;
          } else {
            console.error('Price calculation failed:', data.error);
            totalPriceDisplay.textContent = 'Error calculating price';
          }
        } catch (error) {
          console.error('Failed to calculate price:', error);
          // Fallback to client-side calculation if server is unavailable
          fallbackCalculatePrice(ticketType, ticketQuantity, popcornQuantity);
        } finally {
          priceLoading.style.display = 'none';
        }
      }
      
      // Fallback client-side calculation (backup if server unavailable)
      function fallbackCalculatePrice(ticketType, ticketQuantity, popcornQuantity) {
        const ticketPrice = ticketType === 'pro' ? 40 : 30;
        const popcornPrice = 15;
        
        const ticketSubtotal = ticketPrice * ticketQuantity;
        const popcornSubtotal = popcornPrice * popcornQuantity;
        let total = ticketSubtotal + popcornSubtotal;
        
        // Apply 10% discount for 5+ tickets
        if (ticketQuantity >= 5) {
          total = total * 0.9;
        }
        
        ticketPriceDisplay.textContent = `${ticketPrice} SAR × ${ticketQuantity} = ${ticketSubtotal} SAR`;
        popcornPriceDisplay.textContent = popcornQuantity > 0 ? `15 SAR × ${popcornQuantity} = ${popcornSubtotal} SAR` : '0 SAR';
        
        if (ticketQuantity >= 5) {
          discountRow.style.display = 'flex';
          discountDisplay.textContent = `-${((ticketSubtotal + popcornSubtotal) * 0.1).toFixed(2)} SAR`;
        } else {
          discountRow.style.display = 'none';
        }
        
        totalPriceDisplay.textContent = `${total.toFixed(2)} SAR`;
      }
      
      // Debounced price calculation to avoid too many API calls
      function debouncedCalculatePrice() {
        clearTimeout(priceCalculationTimer);
        priceCalculationTimer = setTimeout(calculatePrice, 300);
      }
      
      // Add event listeners to location inputs
      locationInputs.forEach(input => {
        input.addEventListener('change', checkAndShowSeatAvailability);
      });
      
      // Add event listeners to time inputs
      timeInputs.forEach(input => {
        input.addEventListener('change', checkAndShowSeatAvailability);
      });
      
      // Add event listeners for price calculation
      ticketTypeInputs.forEach(input => {
        input.addEventListener('change', debouncedCalculatePrice);
      });
      
      ticketQuantityInput.addEventListener('input', debouncedCalculatePrice);
      popcornQuantityInput.addEventListener('input', debouncedCalculatePrice);
      
      // Form submission handler
      document.querySelector('.login-card').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = {
          movieName: new URLSearchParams(window.location.search).get('movie') || 'Unknown Movie',
          location: document.querySelector('input[name="cinemaLocation"]:checked')?.value === 'jeddah' 
            ? 'Jeddah – Town Square Jeddah' 
            : 'Riyadh – Al Yasmin district',
          showTime: document.querySelector('input[name="showTime"]:checked')?.value,
          ticketType: document.querySelector('input[name="ticketType"]:checked')?.value,
          ticketQuantity: ticketQuantityInput.value,
          popcornQuantity: popcornQuantityInput.value
        };
        
        try {
          const response = await fetch(`${API_BASE_URL}/booking`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(formData).toString()
          });
          
          const result = await response.json();
          
          if (result.success) {
            alert(`Booking Successful!\nBooking ID: ${result.bookingId}\nTotal: ${result.pricing.total} SAR`);
            window.location.href = 'index.html';
          } else {
            alert(`Booking Failed: ${result.error}`);
          }
        } catch (error) {
          console.error('Booking failed:', error);
          alert('Booking failed. Please try again.');
        }
      });
    });
  </script>
  
  <!-- Hidden field to store calculated total -->
  <input type="hidden" id="calculatedTotal" name="calculatedTotal" value="0">

</body>
</html>

